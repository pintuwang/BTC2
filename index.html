<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR/BTC Strategic Monitor - RESTORED</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: #161616; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        
        @keyframes neon-pulse {
            0% { box-shadow: 0 0 10px #ff0000; background: rgba(255, 0, 0, 0.1); }
            100% { box-shadow: 0 0 30px #ff0000; background: rgba(255, 0, 0, 0.4); }
        }
        .emergency-neon { animation: neon-pulse 0.6s infinite alternate; border: 2px solid red !important; }

        .score-card { text-align: center; padding: 30px; border-radius: 12px; background: #222; margin-bottom: 25px; border: 1px solid #444; transition: 0.5s; }
        .chart-box { height: 450px; margin-bottom: 30px; }
        input { background: #222; color: #00ff88; border: 1px solid #444; padding: 10px; border-radius: 5px; width: 100px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; background: #1a1a1a; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <div class="score-card" id="statusCard">
            <h1 id="liveScore" style="font-size: 3.5em; margin: 0;">--</h1>
            <p id="statusLabel" style="font-weight: bold; letter-spacing: 2px;"></p>
        </div>

        <div style="margin-bottom: 20px; display:flex; justify-content: space-between; align-items: center;">
            <div>
                <label>Target Strike: $</label>
                <input type="number" id="strikeVal" value="150" oninput="refreshDisplay()">
            </div>
            <div id="syncTag" style="color: #666; font-size: 0.85em;"></div>
        </div>

        <div class="chart-box">
            <canvas id="mstrBtcChart"></canvas>
        </div>

        <h3>Institutional Trend History</h3>
        <table>
            <thead><tr><th>Date</th><th>MSTR Spot</th><th>Max Pain</th><th>Risk Level</th></tr></thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>

<script>
    let rawData = null;
    let chartObj = null;

    async function loadData() {
        const response = await fetch('./data/history.json');
        rawData = await response.json();
        document.getElementById('syncTag').innerText = `Sync: ${rawData.last_update}`;
        refreshDisplay();
        renderLogTable();
    }

    function refreshDisplay() {
        const strike = parseFloat(document.getElementById('strikeVal').value);
        const spot = rawData.spot;
        const pain = rawData.data[0].mstr_pain;

        let score = 0;
        if (spot > strike * 1.10) score += 4;
        if (pain > strike) score += 6;

        const card = document.getElementById('statusCard');
        document.getElementById('liveScore').innerText = `${score}/10`;
        
        card.className = "score-card";
        if (spot <= strike * 1.05) {
            card.classList.add('emergency-neon');
            document.getElementById('statusLabel').innerText = "⚠️ EMERGENCY: DEFEND STRIKE";
        } else {
            document.getElementById('statusLabel').innerText = score >= 8 ? "SAFE TRADING" : "CAUTION";
            card.style.borderColor = score >= 8 ? "#00ff88" : "#ffcc00";
            card.style.color = score >= 8 ? "#00ff88" : "#ffcc00";
        }

        updateChart(strike);
    }

    async function renderLogTable() {
        const res = await fetch('./data/history_log.json');
        const logs = await res.json();
        document.getElementById('historyList').innerHTML = logs.reverse().map(l => `
            <tr>
                <td>${l.date}</td>
                <td>$${l.spot}</td>
                <td>$${l.mstr_pain}</td>
                <td style="color:${l.score >= 8 ? '#00ff88' : '#ff4444'}">${l.score >= 8 ? '✓ Healthy' : '⚠ Shifting'}</td>
            </tr>
        `).join('');
    }

    function updateChart(strike) {
        const ctx = document.getElementById('mstrBtcChart').getContext('2d');
        if (chartObj) chartObj.destroy();

        chartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: rawData.data.map(d => d.date), // RESTORED 6-WEEK LABELS
                datasets: [
                    {
                        label: 'MSTR Max Pain',
                        data: rawData.data.map(d => d.mstr_pain),
                        borderColor: '#00ff88',
                        tension: 0.3
                    },
                    {
                        label: 'BTC Pain (Scaled)',
                        data: rawData.data.map(d => d.btc_pain / 550), // RESTORED BTC LINE
                        borderColor: '#3498db',
                        borderDash: [5, 5],
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: '#222' } }
                }
            }
        });
    }

    loadData();
</script>
</body>
</html>

  
