<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR/BTC Strategic Monitor - Fixed Scaling</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: #181818; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        .controls { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; border: 1px solid #444; gap: 20px; }
        input { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; width: 100px; }
        .score-box { text-align: center; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid transparent; }
        .safe-bg { background: rgba(0, 255, 136, 0.1); border-color: #00ff88; color: #00ff88; }
        #chart-wrapper { height: 550px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ðŸ“ˆ MSTR Strategic Monitor (Fixed Axis)</h2>
        <div class="controls">
            <label>Target Strike: $</label><input type="number" id="strikeInput" value="150" oninput="updateAnalysis()">
            <div id="last-update" style="font-size: 0.8em; color: #888; margin-left: auto;"></div>
        </div>
        
        <div id="scoreBox" class="score-box"><h1 id="scoreValue">--</h1><p id="scoreLabel">INITIALIZING...</p></div>
        
        <div id="chart-wrapper"><canvas id="maxPainChart"></canvas></div>
    </div>

<script>
    let globalPayload;
    let myChart = null;

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
        try {
            const response = await fetch('./data/history.json');
            const rawData = await response.json();
            const spot = rawData.spot;

            // SANITY FILTER: Only show pain points within 50% of the spot price.
            // This prevents the 0-500 scaling issue caused by Mar 20 ($510) and Jan 16 ($62).
            globalPayload = {
                ...rawData,
                data: rawData.data.filter(d => d.mstr_pain > (spot * 0.5) && d.mstr_pain < (spot * 1.5))
            };

            document.getElementById('last-update').innerText = `Last Sync: ${globalPayload.last_update}`;
            renderMainChart();
            updateAnalysis();
        } catch (e) { console.error("Data Load Error:", e); }
    }

    function updateAnalysis() {
        if (!globalPayload) return;
        const strike = parseFloat(document.getElementById('strikeInput').value);
        const score = globalPayload.spot > strike ? 10 : 4;
        document.getElementById('scoreValue').innerText = `Safety Score: ${score}/10`;
        document.getElementById('scoreBox').className = "score-box safe-bg";
    }

    function renderMainChart() {
        const ctx = document.getElementById('maxPainChart').getContext('2d');
        const labels = globalPayload.data.map(d => d.date);

        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line', label: 'MSTR Pain',
                        data: globalPayload.data.map(d => d.mstr_pain),
                        borderColor: '#00ff88', borderWidth: 3, yAxisID: 'yPrice', tension: 0.3, order: 1
                    },
                    {
                        type: 'line', label: 'BTC Pain',
                        data: globalPayload.data.map(d => d.btc_pain),
                        borderColor: '#3498db', borderDash: [5, 5], yAxisID: 'yBTC', order: 1
                    },
                    {
                        type: 'bar', label: 'Calls',
                        data: globalPayload.data.map(d => d.call_oi),
                        backgroundColor: 'rgba(0, 255, 136, 0.1)', yAxisID: 'yVol', stack: 's1', order: 2
                    },
                    {
                        type: 'bar', label: 'Puts',
                        data: globalPayload.data.map(d => d.put_oi),
                        backgroundColor: 'rgba(255, 68, 68, 0.1)', yAxisID: 'yVol', stack: 's1', order: 2
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    yPrice: { 
                        position: 'left', 
                        title: { display: true, text: 'MSTR ($)', color: '#00ff88' },
                        // This forces the chart to zoom in on the 140-200 range
                        beginAtZero: false,
                        grace: '10%' 
                    },
                    yBTC: { 
                        position: 'right', 
                        grid: { display: false },
                        title: { display: true, text: 'BTC ($)', color: '#3498db' }
                    },
                    yVol: { display: false } // Volume bars don't interfere with price scale
                }
            }
        });
    }
</script>
</body>
</html>
