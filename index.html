<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR Strategic Monitor - PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #161616; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        
        /* NEON EMERGENCY ALERT */
        @keyframes neon-pulse {
            0% { box-shadow: 0 0 10px #ff0000; background: rgba(255, 0, 0, 0.1); }
            100% { box-shadow: 0 0 30px #ff0000; background: rgba(255, 0, 0, 0.4); }
        }
        .neon-emergency { animation: neon-pulse 0.6s infinite alternate; border: 2px solid #ff0000 !important; color: white !important; }

        .score-box { text-align: center; padding: 30px; border-radius: 12px; margin-bottom: 25px; background: #222; border: 1px solid #444; transition: 0.5s; }
        .safe-text { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
        
        input { background: #222; color: #00ff88; border: 1px solid #444; padding: 10px; border-radius: 5px; width: 100px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { text-align: left; color: #888; border-bottom: 2px solid #333; padding: 10px; }
        td { padding: 12px; border-bottom: 1px solid #222; }
        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4444; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2>MSTR Strategic Monitor</h2>
            <div id="last-update" style="color:#666; font-size:0.8em;"></div>
        </div>

        <div class="score-box" id="mainDisplay">
            <div style="font-size: 0.9em; color: #888; margin-bottom: 10px;">SAFETY SCORE</div>
            <h1 id="scoreValue" style="font-size: 3em; margin: 0;">--</h1>
            <p id="scoreLabel" style="font-weight: bold; letter-spacing: 2px;"></p>
        </div>

        <div style="margin-bottom: 20px; display:flex; gap: 20px; align-items: center;">
            <label>Target Strike: $</label>
            <input type="number" id="strikeInput" value="150" oninput="refreshUI()">
        </div>

        <div style="height: 350px;">
            <canvas id="mainChart"></canvas>
        </div>

        <h3>Institutional History (GitHub Log)</h3>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>MSTR Spot</th>
                    <th>Max Pain</th>
                    <th>Risk Trend</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

<script>
    let marketData = null;
    let chartInstance = null;

    async function init() {
        const resp = await fetch('./data/history.json');
        marketData = await resp.json();
        document.getElementById('last-update').innerText = `Sync: ${marketData.last_update}`;
        refreshUI();
        loadHistoryTable();
    }

    function refreshUI() {
        const strike = parseFloat(document.getElementById('strikeInput').value);
        const spot = marketData.spot;
        const pain = marketData.data[0].mstr_pain;
        const display = document.getElementById('mainDisplay');
        
        // Score Calculation
        let score = 0;
        if (spot > strike * 1.10) score += 4;
        if (pain > strike) score += 6;

        document.getElementById('scoreValue').innerText = `${score}/10`;

        // Emergency Neon Logic
        display.className = "score-box";
        if (spot <= strike * 1.05) {
            display.classList.add('neon-emergency');
            document.getElementById('scoreLabel').innerText = "‚ö†Ô∏è EMERGENCY: EXTREME RISK";
        } else {
            document.getElementById('scoreLabel').innerText = score >= 8 ? "SAFE TO SELL" : "CAUTION";
            if (score >= 8) display.classList.add('safe-text');
        }

        renderChart(strike);
    }

    async function loadHistoryTable() {
        const resp = await fetch('./data/history_log.json');
        const logs = await resp.json();
        const strike = document.getElementById('strikeInput').value;
        const html = logs.reverse().map(log => `
            <tr>
                <td>${log.date}</td>
                <td>$${log.spot}</td>
                <td>$${log.mstr_pain}</td>
                <td class="${log.mstr_pain >= strike ? 'trend-up' : 'trend-down'}">
                    ${log.mstr_pain >= strike ? 'üõ°Ô∏è Protected' : '‚ö†Ô∏è Exposed'}
                </td>
            </tr>
        `).join('');
        document.getElementById('historyBody').innerHTML = html;
    }

    function renderChart(strikeLine) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: marketData.data.map(d => d.date),
                datasets: [{
                    label: 'Institutional Floor (Max Pain)',
                    data: marketData.data.map(d => d.mstr_pain),
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    fill: true
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    // Simple logic to draw Strike Line
                },
                scales: {
                    y: {
                        grid: { color: '#222' },
                        // Manual Strike Line via scale annotation
                    }
                }
            }
        });
    }

    init();
</script>
</body>
</html>
