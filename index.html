<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR Strategic Monitor - PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        
        /* Neon Emergency Alert */
        @keyframes neon-pulse {
            0% { box-shadow: 0 0 10px #ff0000; background: rgba(255, 0, 0, 0.1); }
            100% { box-shadow: 0 0 30px #ff0000; background: rgba(255, 0, 0, 0.5); }
        }
        .emergency { animation: neon-pulse 0.5s infinite alternate; border: 2px solid red !important; }

        .score-box { text-align: center; padding: 20px; border-radius: 10px; background: #222; margin-bottom: 20px; transition: 0.5s; }
        .controls { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; padding: 15px; background: #252525; border-radius: 8px; }
        input { background: #333; color: #00ff88; border: 1px solid #555; padding: 8px; border-radius: 4px; font-weight: bold; width: 80px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th { text-align: left; color: #777; border-bottom: 2px solid #333; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>
    <div class="container">
        <div class="score-box" id="alertBox">
            <h1 id="scoreVal" style="font-size: 3em; margin:0;">--</h1>
            <p id="scoreText" style="letter-spacing: 2px; font-weight: bold;"></p>
        </div>

        <div class="controls">
            <label>Target Strike: $</label>
            <input type="number" id="strikeInput" value="150" oninput="updateUI()">
            <div id="syncTime" style="margin-left: auto; color: #555; font-size: 0.8em;"></div>
        </div>

        <div style="height: 400px; position: relative;">
            <canvas id="chartCanvas"></canvas>
        </div>

        <h3>Historical Safety Log</h3>
        <table>
            <thead><tr><th>Date</th><th>MSTR Spot</th><th>Max Pain</th><th>Status</th></tr></thead>
            <tbody id="logTable"></tbody>
        </table>
    </div>

<script>
    let mainData = null;
    let chart = null;

    async function start() {
        const r1 = await fetch('./data/history.json');
        mainData = await r1.json();
        document.getElementById('syncTime').innerText = `Last Sync: ${mainData.last_update}`;
        
        updateUI();
        loadTable();
    }

    function updateUI() {
        const strike = parseFloat(document.getElementById('strikeInput').value);
        const spot = mainData.spot;
        const pain = mainData.data[0].mstr_pain;

        // Score logic
        let score = 0;
        if (spot > strike * 1.15) score += 4;
        if (pain > strike) score += 6;

        document.getElementById('scoreVal').innerText = `${score}/10`;
        const alertBox = document.getElementById('alertBox');
        
        // Emergency Flash
        if (spot <= strike * 1.05) {
            alertBox.className = "score-box emergency";
            document.getElementById('scoreText').innerText = "⚠️ PRICE NEAR STRIKE";
        } else {
            alertBox.className = "score-box";
            alertBox.style.color = score >= 8 ? "#00ff88" : "#ffcc00";
            document.getElementById('scoreText').innerText = score >= 8 ? "SAFE ZONE" : "CAUTION";
        }

        renderChart(strike);
    }

    async function loadTable() {
        const r2 = await fetch('./data/history_log.json');
        const logs = await r2.json();
        document.getElementById('logTable').innerHTML = logs.reverse().map(l => `
            <tr>
                <td>${l.date}</td>
                <td>$${l.spot.toFixed(2)}</td>
                <td>$${l.mstr_pain}</td>
                <td style="color:${l.score >= 8 ? '#00ff88' : '#ff4444'}">${l.score >= 8 ? '✓ Safe' : '⚠ Risk'}</td>
            </tr>
        `).join('');
    }

    function renderChart(strike) {
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: mainData.data.map(d => d.date),
                datasets: [
                    {
                        label: 'MSTR Max Pain',
                        data: mainData.data.map(d => d.mstr_pain),
                        borderColor: '#00ff88',
                        tension: 0.3
                    },
                    {
                        label: 'BTC Proxy (Blue)',
                        data: mainData.data.map(d => d.btc_pain / 500), // Scaled to fit MSTR chart
                        borderColor: '#3498db',
                        borderDash: [5, 5],
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { grid: { color: '#222' } } },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    start();
</script>
</body>
</html>
