<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR/BTC Max Pain Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .advisor-box { background: #252525; border-left: 5px solid #00ff88; padding: 20px; margin-top: 30px; border-radius: 4px; }
        .status { font-size: 0.9em; color: #888; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h2 { color: #00ff88; margin-top: 0; }
        .warning { color: #ff4444; font-weight: bold; }
        .safe { color: #00ff88; font-weight: bold; }
        #chart-wrapper { position: relative; height: 450px; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>MSTR & BTC Institutional Max Pain</h2>
        <div id="last-update" class="status">Connecting to history.json...</div>
        
        <div id="chart-wrapper">
            <canvas id="maxPainChart"></canvas>
        </div>
        
        <div id="advisor" class="advisor-box">
            <h3>Risk Advisor</h3>
            <p id="advice-text">Analyzing market magnets...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

        async function loadData() {
            const adviceEl = document.getElementById('advice-text');
            const updateEl = document.getElementById('last-update');

            try {
                const response = await fetch('./data/history.json');
                if (!response.ok) throw new Error("JSON not found. Run your Python script first.");
                
                const payload = await response.json();
                
                // Update text indicators
                updateEl.innerText = `Last Sync: ${payload.last_update} | MSTR Spot: $${payload.spot.toFixed(2)}`;
                
                const labels = payload.data.map(d => d.date);
                const mstrData = payload.data.map(d => d.mstr_pain);
                const btcData = payload.data.map(d => d.btc_pain);

                renderChart(labels, mstrData, btcData);
                generateAdvice(payload.data, payload.spot);
                
            } catch (err) {
                adviceEl.innerHTML = `<span class='warning'>Error: ${err.message}</span>`;
            }
        }

        function renderChart(labels, mstrData, btcData) {
            const ctx = document.getElementById('maxPainChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'MSTR Max Pain',
                            data: mstrData,
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            yAxisID: 'yMSTR', // Maps to left axis
                            tension: 0.3,
                            fill: true,
                            spanGaps: true // Connects lines across missing data points
                        },
                        {
                            label: 'BTC Max Pain',
                            data: btcData,
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            yAxisID: 'yBTC', // Maps to right axis
                            tension: 0.3,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yMSTR: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'MSTR Price ($)', color: '#00ff88' },
                            grid: { color: '#333' },
                            ticks: { color: '#e0e0e0' }
                        },
                        yBTC: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'BTC Price ($)', color: '#3498db' },
                            // BTC scale is independent (0 to ~110k)
                            grid: { display: false }, 
                            ticks: { color: '#e0e0e0' }
                        },
                        x: {
                            ticks: { color: '#e0e0e0' },
                            grid: { color: '#333' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { size: 14 } } }
                    }
                }
            });
        }

        function generateAdvice(data, spot) {
            const jan16 = data.find(d => d.date === "2026-01-16");
            let html = "";

            if (spot > 150) {
                html += `<p class='safe'>✅ MSTR ($${spot.toFixed(2)}) is above your $150 strike.</p>`;
            } else {
                html += "<p class='warning'>⚠️ ALERT: MSTR is trading below your $150 strike!</p>";
            }

            if (jan16 && jan16.mstr_pain) {
                if (jan16.mstr_pain <= 155) {
                    html += `<p class='warning'>⚠️ PIN RISK: Jan 16 Max Pain is $${jan16.mstr_pain}. High probability of a price "magnet" pulling MSTR toward your strike.</p>`;
                } else {
                    html += `<p>ℹ️ Jan 16 Max Pain is at $${jan16.mstr_pain}. This provides a safety buffer for your position.</p>`;
                }
            }
            document.getElementById('advice-text').innerHTML = html;
        }
    </script>
</body>
</html>
