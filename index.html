<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR/BTC Strategic Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #111; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        
        /* Neon Alert */
        @keyframes pulse-red { 0% { box-shadow: 0 0 5px #ff0000; } 100% { box-shadow: 0 0 25px #ff0000; } }
        .emergency { animation: pulse-red 0.5s infinite alternate; border: 2px solid #ff0000 !important; }

        .score-card { text-align: center; padding: 30px; border-radius: 12px; background: #1a1a1a; border: 1px solid #333; margin-bottom: 20px; transition: 0.3s; }
        .phase-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; background: #333; margin-top: 10px; }
        
        .controls { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        input { background: #000; color: #00ff88; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100px; font-weight: bold; font-size: 1.1em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #151515; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
        th { background: #222; color: #888; font-size: 0.8em; text-transform: uppercase; }
        
        .legend-item { color: #ff4444; font-weight: bold; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="score-card" id="alertBox">
            <h1 id="scoreDisplay" style="font-size: 4em; margin: 0;">--</h1>
            <div id="phaseDisplay" class="phase-badge">Detecting Phase...</div>
            <p id="safetyMsg" style="margin-top: 15px; font-weight: bold; letter-spacing: 1px;"></p>
        </div>

        <div class="controls">
            <div>
                <label style="color:#888;">TARGET STRIKE: </label>
                <input type="number" id="strikeInput" value="150" oninput="updateUI()">
            </div>
            <div style="text-align: right;">
                <div id="sgtClock" style="font-weight: 500;">SGT: --</div>
                <div class="legend-item">â—† RED DIAMOND = Monthly Expiry</div>
            </div>
        </div>

        <div style="height: 450px;">
            <canvas id="mainChart"></canvas>
        </div>

        <h3 style="margin-top:40px; color: #888;">Historical Log (30 Days)</h3>
        <table>
            <thead><tr><th>Date</th><th>MSTR Spot</th><th>Weekly Pain</th><th>Phase</th></tr></thead>
            <tbody id="logTable"></tbody>
        </table>
    </div>

<script>
    let marketData = null;
    let chartObj = null;

    async function init() {
        const res = await fetch('./data/history.json');
        marketData = await res.json();
        
        // SGT Time conversion
        const utc = new Date(marketData.last_update_utc);
        document.getElementById('sgtClock').innerText = `SGT: ${utc.toLocaleString('en-SG', {timeZone:'Asia/Singapore', dateStyle:'medium', timeStyle:'short'})}`;
        
        updateUI();
        loadTable();
    }

    function updateUI() {
        const strike = parseFloat(document.getElementById('strikeInput').value);
        const spot = marketData.spot;
        const pain = marketData.data[0].mstr_pain;
        const phase = marketData.phase;

        // Safety Score Logic
        let score = 0;
        if (spot > strike * 1.15) score += 4;
        else if (spot > strike) score += 2;
        if (pain > strike) score += 6;

        document.getElementById('scoreDisplay').innerText = `${score}/10`;
        document.getElementById('phaseDisplay').innerText = phase;
        
        const alertBox = document.getElementById('alertBox');
        const msg = document.getElementById('safetyMsg');

        // Reset Styles
        alertBox.className = "score-card";
        
        if (spot <= strike * 1.05) {
            alertBox.classList.add('emergency');
            msg.innerText = "ðŸ”´ DANGER: PRICE NEAR STRIKE";
            msg.style.color = "#ff4444";
        } else if (score >= 8) {
            msg.innerText = "ðŸŸ¢ SAFE: INSTITUTIONAL FLOOR DETECTED";
            msg.style.color = "#00ff88";
            alertBox.style.borderColor = "#00ff88";
        } else {
            msg.innerText = "ðŸŸ¡ CAUTION: MONITOR MAGNET TREND";
            msg.style.color = "#ffcc00";
            alertBox.style.borderColor = "#ffcc00";
        }

        renderChart(strike);
    }

    function renderChart(strike) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartObj) chartObj.destroy();

        chartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: marketData.data.map(d => d.date),
                datasets: [
                    {
                        label: 'MSTR Max Pain',
                        data: marketData.data.map(d => d.mstr_pain),
                        borderColor: '#00ff88',
                        yAxisID: 'yLeft',
                        pointStyle: marketData.data.map(d => d.is_monthly ? 'rectRot' : 'circle'),
                        pointRadius: marketData.data.map(d => d.is_monthly ? 10 : 5),
                        pointBackgroundColor: marketData.data.map(d => d.is_monthly ? '#ff4444' : '#00ff88'),
                        tension: 0.3
                    },
                    {
                        label: 'BTC Max Pain (Right Axis)',
                        data: marketData.data.map(d => d.btc_pain),
                        borderColor: '#3498db',
                        borderDash: [5, 5],
                        yAxisID: 'yRight',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yLeft: { type: 'linear', position: 'left', grid: { color: '#222' }, title: { display: true, text: 'MSTR ($)' } },
                    yRight: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'BTC ($)' } }
                },
                plugins: { legend: { labels: { color: '#fff' } } }
            }
        });
    }

    async function loadTable() {
        const res = await fetch('./data/history_log.json');
        const logs = await res.json();
        document.getElementById('logTable').innerHTML = logs.reverse().map(l => `
            <tr>
                <td>${l.date}</td>
                <td>$${l.spot}</td>
                <td>$${l.mstr_pain}</td>
                <td><small>${l.phase}</small></td>
            </tr>
        `).join('');
    }

    init();
</script>
</body>
</html>
